# Map和WeakMap

## 介绍

`Map`是一种字典的数据结构，`Map` 对象保存键值对，并且能够记住键的原始插入顺序。任何值(对象或者原始值) 都可以作为一个键或一个值。一个`Map`对象在迭代时会根据对象中元素的插入顺序来进行。`Map`与普通对象最大的区别就是`Map`的`key`可以是任意类型的。

```js
const a = {};
const b = { [a]: 1 } // 最终会转成字符串 {[object Object]: 1}
const map = new Map();
map.set(b, a); // map的key就是对象a
```

## Map的特点

1. Map 默认情况下不包含任何键，所有键都是自己添加进去的。不同于 Object 原型链上有一些默认的键。
2. Map 的键可以是**任意类型**数据
3. Map 的键值对个数可以**轻易**通过`size`属性获取，Object 需要手动计算。
4. Map 在频繁增删键值对的场景下**性能**要比 Object 好。

## 基本用法

```js
const map = new Map(); // 实例化一个Map
map.set(1, 1); // 添加值
```

## 常见属性和方法

- size: 返回 Map 结构的元素总数
- set(key, value): 向 Map 中加入或更新键值对
- get(key): 读取 key 对用的值，如果没有，返回 undefined
- has(key): 判断某个键是否在 Map 对象中，在返回 true 否则返回 false
- delete(key): 删除某个键，返回 true, 如果删除失败返回 false
- clear(): 清空Map，删除所有元素

遍历`Map`的方法

- keys()：返回`Map`的所有键名，是一个迭代器
- values()：返回`Map`的所有的键值，是一个迭代器
- entries()：返回所有成员的键值对，是一个迭代器
- forEach()：遍历 Map 的所有成员

## WeakMap

> 定义：WeakMap 对象是一组键/值对的集合，其中的键是弱引用的。其键必须是对象，而值可以是任意的

与`Map`的区别

- `Map `的键可以是任意类型，`WeakMap `的键只能是对象类型(null除外)
- `WeakMap `键名所指向的对象，不计入垃圾回收机制
- `WeakMap`不可遍历，因为属性随时可能被回收，所以运行前后成员个数可能不一致。

`WeakMap` 的属性跟操作方法与 `Map` 一致，知识因为是弱引用，里面的属性随时会变动，所以 `WeakMap` 也没有遍历方法

要理解`WeakMap`，首先需要理解什么是强引用，什么是弱引用。

- 强引用

```js
const map = new Map()
let obj = {}
map.set(obj, 'test');
```

如果我们熟悉`js`的垃圾回收机制就知道，当一个对象没有被任何其他内容引用时就会被回收。对于强引用来说，我们的`map`形成对`obj`这个对象的引用。此时对于`{}`这一块内存有`obj`和`map`两个引用，当我们设置`obj = null`时，`obj`已经断开了这块内存区间的引用，但是由于`map`是强引用的，所以`{}`这块内存区间不会被回收，除非我们主动设置`map.delete(obj)`。

- 弱引用

```js
const map = new WeakMap()
let obj = {}
map.set(obj, 'test');
```

弱引用我们可以理解为`js`的垃圾回收机制不会讲这个引用视为有效的引用。如果我们设置`obj = null`，那么对`{}`这块内存区域的引用次数就是1了，因为`map`时弱引用，所以可以不算。

> 总的来说， `WeakMap` 保持了对键名所引用的对象的弱引用，即垃圾回收机制不将该引用考虑在内。只要所引用的对象的其他引用都被清除，垃圾回收机制就会释放该对象所占用的内存。也就是说，一旦不再需要，`WeakMap` 里面的键名对象和所对应的键值对会自动消失，不用手动删除引用。

## 总结

- 弱引用可以方便`js`执行垃圾回收机制，防止开发者忘记手动解除依赖造成内存泄漏
- `Map、WeakMap`、都是一种集合的数据结构
- `Map 和 WeakMap` 是一种键值对的集合，`Map `的键可以是任意类型，`WeakMap `的键只能是除了`null`以外的对象类型
- `Map` 有遍历方法，` WeakMap` 属于弱引用不可遍历

## 参考

https://zh.wikipedia.org/wiki/%E5%BC%B1%E5%BC%95%E7%94%A8